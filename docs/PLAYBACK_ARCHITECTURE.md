# PLAYBACK API - Architecture & Flow Documentation

## Kiáº¿n trÃºc tá»•ng quan

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT (Browser/App)                        â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Video Player â”‚  â”‚ Progress Bar â”‚  â”‚  Controls    â”‚              â”‚
â”‚  â”‚ (HLS/DASH)   â”‚  â”‚   (Seek)     â”‚  â”‚(Play/Pause)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                  â”‚                  â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â”‚ Load Stream      â”‚ Update Position  â”‚ Update Status
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PLAYBACK CONTROLLER                             â”‚
â”‚                                                                       â”‚
â”‚  POST   /playbacks              â† Táº¡o session                        â”‚
â”‚  PATCH  /playbacks/:id/position â† Seek / Heartbeat                   â”‚
â”‚  PATCH  /playbacks/:id/status   â† Play / Pause / Stop                â”‚
â”‚  GET    /playbacks/:id/download â† Download MP4                       â”‚
â”‚  GET    /playbacks/analytics    â† Thá»‘ng kÃª                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PLAYBACK SERVICE                                â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Validation   â”‚  â”‚ Stream URL Gen â”‚  â”‚   Analytics    â”‚        â”‚
â”‚  â”‚  (Recording    â”‚  â”‚ (HLS/DASH/     â”‚  â”‚  (Completion   â”‚        â”‚
â”‚  â”‚   exists &     â”‚  â”‚  RTSP/HTTP)    â”‚  â”‚   Rate, Watch  â”‚        â”‚
â”‚  â”‚   COMPLETED)   â”‚  â”‚                â”‚  â”‚   Duration)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATABASE (PostgreSQL)                         â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  playbacks  â”‚  Nâ”€1  â”‚ recordings  â”‚  Nâ”€1  â”‚   cameras   â”‚       â”‚
â”‚  â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚       â”‚
â”‚  â”‚  - status   â”‚       â”‚  - storage  â”‚       â”‚  - rtspUrl  â”‚       â”‚
â”‚  â”‚  - position â”‚       â”‚  - duration â”‚       â”‚  - channel  â”‚       â”‚
â”‚  â”‚  - streamUrlâ”‚       â”‚  - status   â”‚       â”‚             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Luá»“ng nghiá»‡p vá»¥ chi tiáº¿t

### 1. CREATE PLAYBACK SESSION

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ POST /playbacks
     â”‚ { recordingId: "xxx", protocol: "HLS" }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackController.create()                                 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackService.create()                                    â”‚
â”‚                                                              â”‚
â”‚ STEP 1: Validate Recording                                  â”‚
â”‚   â”œâ”€ Find recording by ID                                   â”‚
â”‚   â”œâ”€ Check status === 'COMPLETED'                           â”‚
â”‚   â””â”€ If not â†’ throw BadRequestException                     â”‚
â”‚                                                              â”‚
â”‚ STEP 2: Validate File                                       â”‚
â”‚   â”œâ”€ Check existsSync(recording.storagePath)                â”‚
â”‚   â””â”€ If not â†’ throw NotFoundException                       â”‚
â”‚                                                              â”‚
â”‚ STEP 3: Generate Stream URL                                 â”‚
â”‚   â”œâ”€ HLS:  http://host/playback/{id}/index.m3u8            â”‚
â”‚   â”œâ”€ DASH: http://host/playback/{id}/manifest.mpd          â”‚
â”‚   â”œâ”€ RTSP: rtsp://host/playback/{id}                        â”‚
â”‚   â””â”€ HTTP_MP4: http://api/playbacks/{id}/download           â”‚
â”‚                                                              â”‚
â”‚ STEP 4: Extract User Info                                   â”‚
â”‚   â”œâ”€ req.user â†’ userId, username                            â”‚
â”‚   â”œâ”€ req.headers['user-agent'] â†’ userAgent                  â”‚
â”‚   â””â”€ req.ip / x-forwarded-for â†’ clientIp                    â”‚
â”‚                                                              â”‚
â”‚ STEP 5: Create Playback Entity                              â”‚
â”‚   â”œâ”€ status: PENDING                                        â”‚
â”‚   â”œâ”€ currentPositionSec: 0                                  â”‚
â”‚   â”œâ”€ startedAt: null (chÆ°a báº¯t Ä‘áº§u)                         â”‚
â”‚   â””â”€ Save to DB                                             â”‚
â”‚                                                              â”‚
â”‚ STEP 6: Return with Relations                               â”‚
â”‚   â””â”€ Include recording & camera objects                     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response 201 Created                                         â”‚
â”‚ {                                                            â”‚
â”‚   id: "playback-uuid",                                       â”‚
â”‚   streamUrl: "http://.../index.m3u8",                        â”‚
â”‚   protocol: "HLS",                                           â”‚
â”‚   status: "PENDING",                                         â”‚
â”‚   recording: {...},                                          â”‚
â”‚   camera: {...}                                              â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. START PLAYING (Auto Status Update)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚ User click Play / Video player loads
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ PATCH /playbacks/{id}/position
     â”‚ { currentPositionSec: 0 }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackController.updatePosition()                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackService.updatePosition()                            â”‚
â”‚                                                              â”‚
â”‚ 1. Validate Position                                        â”‚
â”‚    â”œâ”€ currentPositionSec >= 0                               â”‚
â”‚    â””â”€ currentPositionSec <= recording.durationSec           â”‚
â”‚                                                              â”‚
â”‚ 2. Auto-update Status (if PENDING)                          â”‚
â”‚    â”œâ”€ status: PENDING â†’ PLAYING                             â”‚
â”‚    â””â”€ startedAt: now()                                      â”‚
â”‚                                                              â”‚
â”‚ 3. Check Auto-complete (if PLAYING)                         â”‚
â”‚    â”œâ”€ If position >= 95% duration                           â”‚
â”‚    â”œâ”€ status: PLAYING â†’ COMPLETED                           â”‚
â”‚    â””â”€ endedAt: now()                                        â”‚
â”‚                                                              â”‚
â”‚ 4. Update Database                                          â”‚
â”‚    â””â”€ Save changes                                          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response 200 OK                                              â”‚
â”‚ {                                                            â”‚
â”‚   id: "playback-uuid",                                       â”‚
â”‚   status: "PLAYING",      â† Changed from PENDING            â”‚
â”‚   startedAt: "2025-10-02T10:00:00Z", â† Auto-set            â”‚
â”‚   currentPositionSec: 0,                                     â”‚
â”‚   ...                                                        â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. HEARTBEAT (Track Watch Duration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚ setInterval(() => updatePosition(), 10000)
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ Every 10 seconds
     â–¼
     â”‚ PATCH /playbacks/{id}/position
     â”‚ { currentPositionSec: 10 }
     â–¼
     â”‚ PATCH /playbacks/{id}/position
     â”‚ { currentPositionSec: 20 }
     â–¼
     â”‚ PATCH /playbacks/{id}/position
     â”‚ { currentPositionSec: 30 }
     â–¼
     ...

Purpose:
- Track how long user actually watched
- Calculate watch duration for analytics
- Auto-complete when reach 95% duration
```

### 4. SEEK (Tua video)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚ User drags progress bar to 2:00
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ PATCH /playbacks/{id}/position
     â”‚ { currentPositionSec: 120 }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackService.updatePosition()                            â”‚
â”‚                                                              â”‚
â”‚ Update currentPositionSec: 120                               â”‚
â”‚ Keep status: PLAYING                                         â”‚
â”‚ Video player will seek to 2:00                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. PAUSE & RESUME

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚ User click Pause
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ PATCH /playbacks/{id}/status
     â”‚ { status: "PAUSED" }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackService.updateStatus()                              â”‚
â”‚                                                              â”‚
â”‚ status: PLAYING â†’ PAUSED                                     â”‚
â”‚ Keep currentPositionSec (Ä‘á»ƒ resume sau)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     ... (user does something else) ...
     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚ User click Resume
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ PATCH /playbacks/{id}/status
     â”‚ { status: "PLAYING" }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackService.updateStatus()                              â”‚
â”‚                                                              â”‚
â”‚ status: PAUSED â†’ PLAYING                                     â”‚
â”‚ Continue from currentPositionSec                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6. AUTO-COMPLETION

```
Current position: 285 seconds
Recording duration: 300 seconds
Completion threshold: 300 * 0.95 = 285 seconds

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚ Heartbeat update
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ PATCH /playbacks/{id}/position
     â”‚ { currentPositionSec: 285 }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackService.updatePosition()                            â”‚
â”‚                                                              â”‚
â”‚ Check: 285 >= 285 (95% of 300) â†’ TRUE                       â”‚
â”‚                                                              â”‚
â”‚ Auto-complete:                                               â”‚
â”‚   â”œâ”€ status: PLAYING â†’ COMPLETED                            â”‚
â”‚   â”œâ”€ endedAt: now()                                         â”‚
â”‚   â””â”€ currentPositionSec: 285                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7. DOWNLOAD (HTTP_MP4 with Range Support)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ GET /playbacks/{id}/download
     â”‚ Headers: Range: bytes=0-1000000
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackController.download()                               â”‚
â”‚                                                              â”‚
â”‚ 1. Get playback session                                     â”‚
â”‚                                                              â”‚
â”‚ 2. Get file path from recording.storagePath                 â”‚
â”‚                                                              â”‚
â”‚ 3. Check file exists (statSync)                             â”‚
â”‚                                                              â”‚
â”‚ 4. Parse Range header                                       â”‚
â”‚    â”œâ”€ If Range: bytes=0-1000000                             â”‚
â”‚    â”œâ”€ Response: 206 Partial Content                         â”‚
â”‚    â”œâ”€ Content-Range: bytes 0-1000000/50000000               â”‚
â”‚    â””â”€ Stream chunk [0, 1000000]                             â”‚
â”‚                                                              â”‚
â”‚    â”œâ”€ If No Range:                                          â”‚
â”‚    â”œâ”€ Response: 200 OK                                      â”‚
â”‚    â”œâ”€ Content-Length: 50000000                              â”‚
â”‚    â””â”€ Stream full file                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
- Browser can seek video without full download
- Resume download náº¿u bá»‹ giÃ¡n Ä‘oáº¡n
- Progressive playback (play while downloading)
```

### 8. ANALYTICS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ GET /playbacks/analytics?cameraId={id}&from={date}&to={date}
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackService.getAnalytics()                              â”‚
â”‚                                                              â”‚
â”‚ 1. Query playbacks with filters                             â”‚
â”‚                                                              â”‚
â”‚ 2. Calculate metrics:                                       â”‚
â”‚    â”œâ”€ totalSessions: count(*)                               â”‚
â”‚    â”œâ”€ completedSessions: count(status=COMPLETED)            â”‚
â”‚    â”œâ”€ averageWatchDuration: avg(endedAt - startedAt)        â”‚
â”‚    â”œâ”€ completionRate: (completed / total) * 100             â”‚
â”‚    â””â”€ uniqueUsers: count(distinct userId)                   â”‚
â”‚                                                              â”‚
â”‚ 3. Return aggregated data                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response 200 OK                                              â”‚
â”‚ {                                                            â”‚
â”‚   totalSessions: 150,                                        â”‚
â”‚   completedSessions: 120,                                    â”‚
â”‚   averageWatchDuration: 180,  // seconds                    â”‚
â”‚   completionRate: 80.0,        // percent                   â”‚
â”‚   uniqueUsers: 45                                            â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security & Authorization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request                                                       â”‚
â”‚ Headers: Authorization: Bearer <JWT>                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JwtAuthGuard                                                  â”‚
â”‚   â”œâ”€ Verify JWT signature                                    â”‚
â”‚   â”œâ”€ Check expiration                                        â”‚
â”‚   â””â”€ Decode payload â†’ req.user = { id, username, role }      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RolesGuard                                                    â”‚
â”‚   â”œâ”€ Get required roles from @Roles decorator                â”‚
â”‚   â”œâ”€ Check req.user.role in requiredRoles                    â”‚
â”‚   â””â”€ If not â†’ throw ForbiddenException                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller Method                                             â”‚
â”‚                                                               â”‚
â”‚ @Roles('ADMIN', 'OPERATOR', 'VIEWER')                        â”‚
â”‚ create() â†’ All roles can create playback                     â”‚
â”‚                                                               â”‚
â”‚ @Roles('ADMIN', 'OPERATOR')                                  â”‚
â”‚ delete() â†’ Only ADMIN/OPERATOR can delete                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Permission Matrix:**

| Endpoint | ADMIN | OPERATOR | VIEWER |
|----------|-------|----------|--------|
| POST /playbacks | âœ… | âœ… | âœ… |
| GET /playbacks | âœ… | âœ… | âœ… |
| GET /playbacks/:id | âœ… | âœ… | âœ… |
| PATCH /playbacks/:id/position | âœ… | âœ… | âœ… |
| PATCH /playbacks/:id/status | âœ… | âœ… | âœ… |
| GET /playbacks/:id/download | âœ… | âœ… | âœ… |
| GET /playbacks/analytics | âœ… | âœ… | âŒ |
| DELETE /playbacks/:id | âœ… | âœ… | âŒ |

---

## ğŸ’¾ Database Design

### Entity Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cameras    â”‚       â”‚ recordings  â”‚       â”‚  playbacks  â”‚
â”‚             â”‚       â”‚             â”‚       â”‚             â”‚
â”‚ - id (PK)   â”‚â—„â”€â”    â”‚ - id (PK)   â”‚â—„â”€â”    â”‚ - id (PK)   â”‚
â”‚ - name      â”‚  â”‚    â”‚ - camera_id â”‚  â”‚    â”‚ - recording â”‚
â”‚ - ipAddress â”‚  â”‚    â”‚ - storage   â”‚  â”‚    â”‚ - camera_id â”‚
â”‚ - channel   â”‚  â”‚    â”‚ - duration  â”‚  â”‚    â”‚ - streamUrl â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚ - status    â”‚  â”‚    â”‚ - protocol  â”‚
                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚ - status    â”‚
                 â”‚                     â”‚    â”‚ - position  â”‚
                 â”‚  N:1                â”‚    â”‚ - userId    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”‚ - clientIp  â”‚
                                       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                    N:1
                                       â”‚
```

### Cascade Delete Behavior

```
DELETE FROM cameras WHERE id = 'xxx'
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ON DELETE CASCADE                    â”‚
â”‚                                      â”‚
â”‚ Auto-delete:                         â”‚
â”‚   â”œâ”€ recordings (camera_id = xxx)   â”‚
â”‚   â”‚   â””â”€ playbacks (recording_id)   â”‚ â† Cascade chain
â”‚   â”‚                                  â”‚
â”‚   â””â”€ playbacks (camera_id = xxx)    â”‚ â† Direct cascade
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result:
âœ… Data consistency maintained
âœ… No orphan records
âœ… Single DELETE statement
```

---

## ğŸ¯ State Machine (Status Transitions)

```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ PENDING â”‚ â† Initial state
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ (first position      â”‚
        â”‚  update)             â”‚ (error)
        â–¼                      â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PLAYING â”‚           â”‚ FAILED  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â–²
        â”‚                      â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  (stream error)      â”‚
        â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                 â”‚
   â”‚ PAUSED  â”‚                 â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚
        â”‚                      â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  (resume)
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PLAYING â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ (user stop)   â”‚ (>= 95%)     â”‚
        â–¼               â–¼              â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚ STOPPED â”‚     â”‚COMPLETED â”‚       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
        â–²               â–²              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Terminal states: STOPPED, COMPLETED, FAILED
```

---

## ğŸ“Š Performance Considerations

### 1. Database Indexes

```sql
-- Fast query by recording
CREATE INDEX IDX_playbacks_recording_id ON playbacks(recording_id);

-- Fast query by camera
CREATE INDEX IDX_playbacks_camera_id ON playbacks(camera_id);

-- Fast filter by status
CREATE INDEX IDX_playbacks_status ON playbacks(status);

-- Fast sort by time
CREATE INDEX IDX_playbacks_created_at ON playbacks(created_at);

-- Fast user history
CREATE INDEX IDX_playbacks_user_created 
ON playbacks(user_id, created_at);
```

### 2. Query Optimization

```typescript
// BAD: N+1 query problem
const playbacks = await playbackRepo.find();
for (const pb of playbacks) {
  const recording = await recordingRepo.findOne(pb.recordingId);
  const camera = await cameraRepo.findOne(pb.cameraId);
}

// GOOD: Use relations (1 query with JOINs)
const playbacks = await playbackRepo.find({
  relations: ['recording', 'camera']
});
```

### 3. Pagination

```typescript
// Always use pagination for list endpoints
const [data, total] = await playbackRepo.findAndCount({
  skip: (page - 1) * pageSize,
  take: pageSize,  // Max 100
  order: { createdAt: 'DESC' }
});
```

---

## ğŸ§ª Testing Strategy

### Unit Tests
```typescript
describe('PlaybackService', () => {
  it('should create playback for COMPLETED recording');
  it('should throw error for PENDING recording');
  it('should throw error if file not exists');
  it('should auto-set PLAYING on first position update');
  it('should auto-complete when position >= 95%');
  it('should calculate analytics correctly');
});
```

### Integration Tests
```typescript
describe('Playback API (E2E)', () => {
  it('POST /playbacks â†’ 201 with streamUrl');
  it('PATCH /playbacks/:id/position â†’ auto-start');
  it('PATCH /playbacks/:id/status â†’ pause/resume');
  it('GET /playbacks/:id/download â†’ stream MP4');
  it('GET /playbacks/analytics â†’ correct metrics');
});
```

---

**Author:** Camera API Team  
**Last Updated:** October 2, 2025  
**Version:** 1.0.0
